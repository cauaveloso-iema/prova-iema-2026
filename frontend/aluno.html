<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Aluno - Sistema de Provas</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .aluno-header {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .aluno-info {
            flex: 1;
        }
        
        .aluno-info h1 {
            margin: 0 0 10px 0;
            font-size: 1.8rem;
        }
        
        .aluno-details {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .btn-entrar-turma {
            background: white;
            color: #10b981;
            border: 2px solid #10b981;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-entrar-turma:hover {
            background: #10b981;
            color: white;
            transform: translateY(-2px);
        }
        
        .prova-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-left: 4px solid;
            transition: transform 0.3s;
        }
        
        .prova-card:hover {
            transform: translateY(-3px);
        }
        
        .prova-card.pendente {
            border-left-color: #f59e0b;
        }
        
        .prova-card.concluida {
            border-left-color: #6b7280;
        }
        
        .prova-card.ativa {
            border-left-color: #10b981;
        }
        
        .prova-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .prova-titulo {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .prova-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-pendente {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-concluida {
            background: #f3f4f6;
            color: #374151;
        }
        
        .status-ativa {
            background: #d1fae5;
            color: #065f46;
        }
        
        .prova-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .prova-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .prova-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-iniciar-prova {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }
        
        .btn-iniciar-prova:hover {
            background: #059669;
        }
        
        .btn-ver-resultado {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }
        
        .btn-ver-resultado:hover {
            background: #3730a3;
        }
        
        .btn-sair-prova {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }
        
        .btn-sair-prova:hover {
            background: #dc2626;
        }
        
        .turma-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 3px solid #4f46e5;
        }
        
        .turma-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .turma-codigo {
            background: #f3f4f6;
            padding: 5px 10px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        
        .btn-logout {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
        }
        
        .loading i {
            font-size: 2rem;
            color: #4f46e5;
        }
    </style>
</head>
<!-- Incluir Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Incluir o chatbot -->
<script src="js/chatbot-frontend.js"></script>

<!-- Opcional: A√ß√£o espec√≠fica para alunos -->
<script>
// Exemplo: Mostrar mensagem especial quando o aluno carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (window.chatbot) {
            window.chatbot.sendSystemMessage("üí° Dica: Voc√™ pode usar o assistente para tirar d√∫vidas sobre suas provas!");
        }
    }, 3000);
});
</script>
<body>
    <!-- Bot√£o de Logout -->
    <button class="btn-logout" id="btnLogout">
        <i class="fas fa-sign-out-alt"></i> Sair
    </button>
    
    <div class="container">
        <!-- Header do Aluno -->
        <div class="aluno-header">
            <div class="aluno-info">
                <h1><i class="fas fa-user-graduate"></i> Painel do Aluno</h1>
                <div class="aluno-details" id="alunoDetails">
                    <p>Carregando informa√ß√µes...</p>
                </div>
            </div>
            <button class="btn-entrar-turma" id="btnEntrarTurma">
                <i class="fas fa-plus-circle"></i> Entrar em Turma
            </button>
        </div>
        
        <!-- Provas Pendentes -->
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-clock"></i> Provas Pendentes</h2>
            </div>
            <div class="card-body">
                <div id="provasPendentes">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando provas pendentes...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Provas Conclu√≠das -->
        <div class="card" style="margin-top: 30px;">
            <div class="card-header">
                <h2><i class="fas fa-check-circle"></i> Provas Conclu√≠das</h2>
            </div>
            <div class="card-body">
                <div id="provasConcluidas">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando provas conclu√≠das...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Turmas -->
        <div class="card" style="margin-top: 30px; margin-bottom: 50px;">
            <div class="card-header">
                <h2><i class="fas fa-school"></i> Minhas Turmas</h2>
            </div>
            <div class="card-body">
                <div id="turmasAluno">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Carregando suas turmas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Entrar na Turma -->
    <div class="modal" id="modalEntrarTurma">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-sign-in-alt"></i> Entrar em uma Turma</h3>
                <button class="modal-close" onclick="fecharModal('modalEntrarTurma')">&times;</button>
            </div>
            <div class="form-group">
                <label for="codigoTurma">C√≥digo da Turma</label>
                <input type="text" id="codigoTurma" class="form-control" placeholder="Ex: ABC123" style="text-transform: uppercase;">
                <small style="color: #6b7280; display: block; margin-top: 5px;">Pergunte ao professor pelo c√≥digo da turma</small>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-iniciar-prova" style="flex: 1;" onclick="entrarNaTurma()">
                    <i class="fas fa-check"></i> Entrar
                </button>
                <button class="btn-sair-prova" style="flex: 1;" onclick="fecharModal('modalEntrarTurma')">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Iniciar Prova -->
    <div class="modal" id="modalIniciarProva">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-play-circle"></i> Iniciar Prova</h3>
                <button class="modal-close" onclick="fecharModal('modalIniciarProva')">&times;</button>
            </div>
            <div id="modalProvaInfo">
                <!-- Informa√ß√µes da prova ser√£o inseridas aqui -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-iniciar-prova" style="flex: 1;" onclick="iniciarProvaSelecionada()">
                    <i class="fas fa-play"></i> Iniciar Prova
                </button>
                <button class="btn-sair-prova" style="flex: 1;" onclick="fecharModal('modalIniciarProva')">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Configura√ß√£o da API
        const API_BASE_URL = 'https://sistema-avaliativo-iemacentro.onrender.com/api';
        
        // Vari√°veis globais
        let usuario = null;
        let provasPendentes = [];
        let provasConcluidas = [];
        let turmas = [];
        let provaSelecionada = null;
        
        // Fun√ß√µes do modal
        function mostrarModal(id) {
            document.getElementById(id).style.display = 'flex';
        }
        
        function fecharModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        // Carregar dados do aluno
        async function carregarDadosAluno() {
            try {
                const token = localStorage.getItem('auth_token');
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Buscar dados atualizados do usu√°rio
                const userResponse = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (userResponse.status === 401) {
                    localStorage.clear();
                    window.location.href = 'login.html';
                    return;
                }
                
                const userData = await userResponse.json();
                
                if (userData.success) {
                    usuario = userData.user;
                    localStorage.setItem('user_data', JSON.stringify(usuario));
                    
                    if (usuario.role !== 'aluno') {
                        alert('Apenas alunos podem acessar esta p√°gina');
                        window.location.href = usuario.role === 'professor' ? 'index.html' : 'login.html';
                        return;
                    }
                    
                    // Atualizar informa√ß√µes do aluno
                    document.getElementById('alunoDetails').innerHTML = `
                        <p><strong>${usuario.nome}</strong></p>
                        <p>${usuario.curso ? usuario.curso + ' | ' : ''}${usuario.matricula || 'Sem matr√≠cula'}</p>
                        <p>${usuario.email}</p>
                    `;
                    
                    // Carregar provas pendentes e turmas
                    await carregarProvasPendentes();
                    await carregarTurmasAluno();
                    
                } else {
                    throw new Error(userData.error || 'Erro ao carregar dados do usu√°rio');
                }
                
            } catch (error) {
                console.error('Erro ao carregar dados do aluno:', error);
                mostrarErro('Erro ao carregar dados. Verifique sua conex√£o.');
            }
        }
        
        // Carregar provas pendentes do aluno - ROTA NOVA
        async function carregarProvasPendentes() {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE_URL}/aluno/provas/pendentes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    provasPendentes = data.provas || [];
                    
                    // Atualizar interface
                    atualizarListaProvas('provasPendentes', provasPendentes, 'pendente');
                    
                    // Carregar provas conclu√≠das tamb√©m
                    await carregarProvasConcluidas();
                } else {
                    throw new Error(data.error || 'Erro ao carregar provas pendentes');
                }
            } catch (error) {
                console.error('Erro ao carregar provas pendentes:', error);
                document.getElementById('provasPendentes').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Erro ao carregar provas</h3>
                        <p>${error.message || 'Tente recarregar a p√°gina'}</p>
                    </div>
                `;
            }
        }
        
        // Carregar provas conclu√≠das
        async function carregarProvasConcluidas() {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE_URL}/aluno/provas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                console.log('üìä Dados recebidos da API:', data);
                
                if (data.success) {
                    // Filtrar apenas as conclu√≠das
                    provasConcluidas = (data.provas || []).filter(p => {
                        console.log(`Prova: ${p.titulo}, Status: ${p.status}, Nota: ${p.nota}, StatusCorrecao: ${p.statusCorrecao}`);
                        return p.status === 'concluida';
                    });
                    
                    console.log(`‚úÖ ${provasConcluidas.length} provas conclu√≠das encontradas`);
                    
                    // Atualizar interface
                    atualizarListaProvas('provasConcluidas', provasConcluidas, 'concluida');
                }
            } catch (error) {
                console.error('Erro ao carregar provas conclu√≠das:', error);
                document.getElementById('provasConcluidas').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Erro ao carregar provas conclu√≠das</h3>
                        <p>Tente recarregar a p√°gina</p>
                    </div>
                `;
            }
        }

        // Nova fun√ß√£o para carregar provas aguardando corre√ß√£o
        async function carregarProvasAguardandoCorrecao() {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE_URL}/aluno/provas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Filtrar provas conclu√≠das mas sem nota liberada
                    const provasAguardando = (data.provas || []).filter(prova => {
                        return prova.status === 'concluida' && 
                            (prova.nota === null || prova.nota === undefined) &&
                            prova.statusCorrecao !== 'corrigida';
                    });
                    
                    if (provasAguardando.length > 0) {
                        const container = document.getElementById('provasConcluidas');
                        if (container) {
                            // Adicionar se√ß√£o de provas aguardando corre√ß√£o
                            container.insertAdjacentHTML('beforeend', `
                                <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                                    <h3 style="color: #6b7280; margin-bottom: 15px;">
                                        <i class="fas fa-clock"></i> Aguardando Corre√ß√£o
                                    </h3>
                                    ${provasAguardando.map(prova => `
                                        <div class="prova-card concluida" style="opacity: 0.7;">
                                            <div class="prova-header">
                                                <h4 class="prova-titulo">${prova.titulo || 'Prova sem t√≠tulo'}</h4>
                                                <span class="prova-status status-pendente">
                                                    AGUARDANDO
                                                </span>
                                            </div>
                                            <div class="prova-info">
                                                <div class="prova-info-item">
                                                    <i class="fas fa-book"></i>
                                                    <span>${prova.conteudo || 'Conte√∫do n√£o especificado'}</span>
                                                </div>
                                                <div class="prova-info-item">
                                                    <i class="fas fa-graduation-cap"></i>
                                                    <span>${prova.turma?.nome || prova.turma?.disciplina || 'Turma n√£o especificada'}</span>
                                                </div>
                                                <div class="prova-info-item">
                                                    <i class="fas fa-question-circle"></i>
                                                    <span>${prova.quantidadeQuestoes || '?'} quest√µes</span>
                                                </div>
                                            </div>
                                            <div class="prova-actions">
                                                <button class="btn-iniciar-prova" style="background: #6b7280;" disabled>
                                                    <i class="fas fa-hourglass-half"></i> Aguardando Corre√ß√£o
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `);
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar provas aguardando corre√ß√£o:', error);
            }
        }
        
        // Atualizar lista de provas na interface
        function atualizarListaProvas(elementId, provas, tipo) {
            const container = document.getElementById(elementId);
            
            if (!provas || provas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-${tipo === 'pendente' ? 'check-circle' : 'file'}"></i>
                        <h3>${tipo === 'pendente' ? 'Nenhuma prova pendente' : 'Nenhuma prova conclu√≠da'}</h3>
                        <p>${tipo === 'pendente' ? 'Todas as provas foram conclu√≠das' : 'Realize suas primeiras provas'}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = provas.map(prova => {
                const dataLimite = prova.dataLimite ? 
                    new Date(prova.dataLimite).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    }) : 'Sem data limite';
                
                const tempoRestante = prova.dataLimite ? 
                    Math.floor((new Date(prova.dataLimite) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                
                const tempoAlerta = tempoRestante !== null && tempoRestante <= 3 ? 
                    `‚è∞ <span style="color: #dc2626;">(Faltam ${tempoRestante} dias)</span>` : '';
                
                return `
                <div class="prova-card ${tipo}">
                    <div class="prova-header">
                        <h4 class="prova-titulo">${prova.titulo || 'Prova sem t√≠tulo'} ${tempoAlerta}</h4>
                        <span class="prova-status status-${tipo}">
                            ${tipo === 'pendente' ? 'PENDENTE' : 'CONCLU√çDA'}
                        </span>
                    </div>
                    <div class="prova-info">
                        <div class="prova-info-item">
                            <i class="fas fa-book"></i>
                            <span>${prova.conteudo || 'Conte√∫do n√£o especificado'}</span>
                        </div>
                        <div class="prova-info-item">
                            <i class="fas fa-graduation-cap"></i>
                            <span>${prova.turma?.nome || prova.turma?.disciplina || 'Turma n√£o especificada'}</span>
                        </div>
                        <div class="prova-info-item">
                            <i class="fas fa-question-circle"></i>
                            <span>${prova.quantidadeQuestoes || '?'} quest√µes</span>
                        </div>
                        ${prova.duracao ? `
                        <div class="prova-info-item">
                            <i class="fas fa-clock"></i>
                            <span>${prova.duracao} min</span>
                        </div>
                        ` : ''}
                        ${prova.dataLimite ? `
                        <div class="prova-info-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span>At√© ${dataLimite}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="prova-actions">
                        ${tipo === 'pendente' ? `
                        <button class="btn-iniciar-prova" onclick="selecionarProva('${prova._id}')">
                            <i class="fas fa-play"></i> Iniciar Prova
                        </button>
                        ` : `
                        <button class="btn-ver-resultado" onclick="verResultado('${prova._id || prova.id}')">
                            <i class="fas fa-star"></i> Ver Nota
                        </button>
                        `}
                    </div>
                </div>
                `;
            }).join('');
        }
        
        // Carregar turmas do aluno
        async function carregarTurmasAluno() {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE_URL}/turmas`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    turmas = data.turmas || [];
                    atualizarListaTurmas();
                }
            } catch (error) {
                console.error('Erro ao carregar turmas:', error);
                document.getElementById('turmasAluno').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Erro ao carregar turmas</h3>
                        <p>Tente recarregar a p√°gina</p>
                    </div>
                `;
            }
        }
        
        // Atualizar lista de turmas
        function atualizarListaTurmas() {
            const container = document.getElementById('turmasAluno');
            
            if (!turmas || turmas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users-slash"></i>
                        <h3>Nenhuma turma</h3>
                        <p>Entre em uma turma usando o c√≥digo</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = turmas.map(turma => `
                <div class="turma-card">
                    <div class="turma-info">
                        <div>
                            <h4 style="margin: 0 0 5px 0;">${turma.nome}</h4>
                            <p style="margin: 0; color: #6b7280; font-size: 0.9rem;">
                                ${turma.disciplina} ‚Ä¢ ${turma.totalProvas || 0} provas ‚Ä¢ ${turma.totalAlunos || 0} alunos
                            </p>
                        </div>
                        <div class="turma-codigo">${turma.codigo}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Entrar em uma turma
        async function entrarNaTurma() {
            const codigo = document.getElementById('codigoTurma').value.trim().toUpperCase();
            
            if (!codigo) {
                alert('Digite o c√≥digo da turma');
                return;
            }
            
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`${API_BASE_URL}/turmas/entrar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ codigo })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ Entrou na turma com sucesso!');
                    fecharModal('modalEntrarTurma');
                    document.getElementById('codigoTurma').value = '';
                    // Recarregar turmas e provas
                    await carregarTurmasAluno();
                    await carregarProvasPendentes();
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
            } catch (error) {
                console.error('Erro ao entrar na turma:', error);
                alert('‚ùå Erro de conex√£o');
            }
        }
        
        // Selecionar prova para iniciar
        function selecionarProva(provaId) {
            provaSelecionada = provasPendentes.find(p => p._id === provaId);
            
            if (!provaSelecionada) {
                alert('Prova n√£o encontrada');
                return;
            }
            
            const dataLimite = provaSelecionada.dataLimite ? 
                new Date(provaSelecionada.dataLimite).toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Sem data limite';
            
            document.getElementById('modalProvaInfo').innerHTML = `
                <h4>${provaSelecionada.titulo || 'Prova sem t√≠tulo'}</h4>
                <p><strong>Conte√∫do:</strong> ${provaSelecionada.conteudo || 'N√£o especificado'}</p>
                
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p><i class="fas fa-info-circle"></i> <strong>Informa√ß√µes da Prova:</strong></p>
                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                        <li><strong>Quantidade de quest√µes:</strong> ${provaSelecionada.quantidadeQuestoes || '?'}</li>
                        <li><strong>Dura√ß√£o:</strong> ${provaSelecionada.duracao || 'N√£o especificada'}</li>
                        <li><strong>Data limite:</strong> ${dataLimite}</li>
                        <li><strong>Turma:</strong> ${provaSelecionada.turma?.nome || provaSelecionada.turma?.disciplina || 'N√£o especificada'}</li>
                        <li><strong>Professor:</strong> ${provaSelecionada.professor || 'N√£o especificado'}</li>
                    </ul>
                </div>
                
                <p><i class="fas fa-exclamation-triangle"></i> <strong>Aten√ß√£o:</strong></p>
                <ul style="margin: 10px 0 0 0; padding-left: 20px; color: #6b7280;">
                    <li>A prova come√ßar√° assim que voc√™ clicar em "Iniciar Prova"</li>
                    <li>O tempo ser√° contado a partir do in√≠cio da prova</li>
                    <li>N√£o recarregue a p√°gina durante a prova</li>
                    <li>Ap√≥s finalizar, n√£o ser√° poss√≠vel retornar</li>
                </ul>
            `;
            
            mostrarModal('modalIniciarProva');
        }
        
        // Fun√ß√£o para iniciar prova selecionada (chamada pelo modal)
        function iniciarProvaSelecionada() {
            if (!provaSelecionada) {
                alert('Nenhuma prova selecionada');
                return;
            }
            
            console.log('üîÑ Iniciando prova selecionada:', provaSelecionada._id);
            
            // Fechar modal
            fecharModal('modalIniciarProva');
            
            // Chamar fun√ß√£o principal para iniciar prova
            iniciarProva(provaSelecionada._id);
        }
    
        // Fun√ß√£o principal para iniciar prova - VERS√ÉO CORRIGIDA
        async function iniciarProva(provaId) {
        console.log('üöÄ Iniciando prova com ID:', provaId);
        
        try {
            // 1. Verificar se est√° autenticado
            const token = localStorage.getItem('auth_token');
            if (!token) {
            alert('Voc√™ precisa estar logado para acessar a prova');
            window.location.href = '/login.html';
            return;
            }
            
            // 2. Verificar dados do usu√°rio
            const userData = localStorage.getItem('user_data');
            if (!userData) {
            alert('Dados do usu√°rio n√£o encontrados');
            window.location.href = '/login.html';
            return;
            }
            
            const usuario = JSON.parse(userData);
            if (usuario.role !== 'aluno') {
            alert('Apenas alunos podem acessar provas');
            window.location.href = usuario.role === 'professor' ? '/index.html' : '/login.html';
            return;
            }
            
            // 3. Limpar tokens antigos de prova
            localStorage.removeItem('provaToken');
            localStorage.removeItem('provaAtual');
            localStorage.removeItem('provaData');
            
            console.log('üîÑ Solicitando acesso √† prova...');
            
            // 4. Mostrar loading
            mostrarLoading('Validando acesso √† prova...');
            
            // 5. Chamar endpoint de acesso
            const response = await fetch(`${API_BASE_URL}/provas/${provaId}/acesso`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
            });
            
            const data = await response.json();
            
            // 6. Verificar resposta
            if (!response.ok || !data.success) {
            throw new Error(data.error || 'Erro ao acessar a prova');
            }
            
            console.log('‚úÖ Acesso autorizado:', data);
            
            // 7. Armazenar tokens corretamente
            if (data.provaToken) {
            localStorage.setItem('provaToken', data.provaToken);
            localStorage.setItem('provaAtual', provaId);
            
            // Armazenar dados da prova para usar na p√°gina de realiza√ß√£o
            if (data.prova) {
                localStorage.setItem('provaData', JSON.stringify(data.prova));
            }
            }
            
            // 8. Redirecionar
            if (data.redirectTo) {
            console.log('üîÑ Redirecionando para:', data.redirectTo);
            window.location.href = data.redirectTo;
            } else if (data.provaToken) {
            window.location.href = `/realizar-prova.html?token=${data.provaToken}`;
            } else {
            throw new Error('N√£o foi poss√≠vel redirecionar para a prova');
            }
            
        } catch (error) {
            console.error('‚ùå Erro ao iniciar prova:', error);
            esconderLoading();
            
            // Mensagens de erro amig√°veis
            let mensagem = 'Erro ao acessar a prova. ';
            
            if (error.message.includes('401') || error.message.includes('token')) {
            mensagem += 'Sua sess√£o expirou. Fa√ßa login novamente.';
            localStorage.clear();
            setTimeout(() => {
                window.location.href = '/login.html';
            }, 2000);
            } else if (error.message.includes('403')) {
            mensagem += 'Voc√™ n√£o tem permiss√£o para acessar esta prova.';
            } else if (error.message.includes('404')) {
            mensagem += 'Prova n√£o encontrada.';
            } else if (error.message.includes('j√° realizou')) {
            mensagem += 'Voc√™ j√° completou esta prova.';
            } else if (error.message.includes('data limite')) {
            mensagem += 'O prazo para esta prova j√° expirou.';
            } else {
            mensagem += error.message || 'Tente novamente.';
            }
            
            alert(mensagem);
        }
        }

        // Adicionar esta fun√ß√£o no in√≠cio do c√≥digo
        function verificarAutenticacao() {
        const token = localStorage.getItem('auth_token');
        const userData = localStorage.getItem('user_data');
        
        if (!token || !userData) {
            window.location.href = '/login.html';
            return false;
        }
        
        try {
            const user = JSON.parse(userData);
            if (user.role !== 'aluno') {
            window.location.href = user.role === 'professor' ? '/index.html' : '/login.html';
            return false;
            }
            return true;
        } catch (e) {
            window.location.href = '/login.html';
            return false;
        }
        }

        // Modificar o carregarDadosAluno para usar verifica√ß√£o
        async function carregarDadosAluno() {
        // Verificar autentica√ß√£o primeiro
        if (!verificarAutenticacao()) {
            return;
        }
        
        try {
            const token = localStorage.getItem('auth_token');
            const userData = localStorage.getItem('user_data');
            
            // Usar dados do localStorage primeiro (mais r√°pido)
            if (userData) {
            usuario = JSON.parse(userData);
            atualizarInfoAluno(usuario);
            }
            
            // Buscar dados atualizados da API
            const response = await fetch(`${API_BASE_URL}/auth/me`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
            });
            
            if (response.status === 401) {
            localStorage.clear();
            window.location.href = '/login.html';
            return;
            }
            
            const data = await response.json();
            
            if (data.success) {
            usuario = data.user;
            localStorage.setItem('user_data', JSON.stringify(usuario));
            atualizarInfoAluno(usuario);
            
            // Carregar dados das provas e turmas
            await carregarProvasPendentes();
            await carregarTurmasAluno();
            } else {
            throw new Error(data.error || 'Erro ao carregar dados');
            }
            
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            mostrarErro('Erro ao carregar dados. Tente recarregar a p√°gina.');
        }
        }

        function atualizarInfoAluno(user) {
        document.getElementById('alunoDetails').innerHTML = `
            <p><strong>${user.nome}</strong></p>
            <p>${user.curso ? user.curso + ' | ' : ''}${user.matricula || 'Sem matr√≠cula'}</p>
            <p>${user.email}</p>
        `;
        }
        
        // Ver resultado da prova
        function verResultado(provaId) {
            console.log('üîç Prova ID recebido:', provaId);
            
            if (!provaId || provaId === 'undefined' || provaId === 'null') {
                alert('Erro: ID da prova n√£o encontrado. Tente recarregar a p√°gina.');
                return;
            }
            
            // Verificar se √© um ObjectId v√°lido (24 caracteres hex)
            if (provaId.length !== 24 || !/^[0-9a-fA-F]{24}$/.test(provaId)) {
                console.error('‚ùå ID da prova inv√°lido:', provaId);
                alert('ID da prova inv√°lido. Contate o administrador.');
                return;
            }
            
            // Redirecionar para p√°gina de resultados do ALUNO
            window.location.href = `resultado-aluno.html?provaId=${provaId}`;
        }
                        
        // Logout
        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
        
        // Mostrar erro
        function mostrarErro(mensagem) {
            const alerta = document.createElement('div');
            alerta.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #ef4444;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            `;
            alerta.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${mensagem}`;
            document.body.appendChild(alerta);
            
            setTimeout(() => {
                alerta.remove();
            }, 5000);
        }
        
        // Fun√ß√µes de loading
        function mostrarLoading(mensagem) {
            // Criar ou mostrar div de loading
            let loadingDiv = document.getElementById('loading-overlay');
            
            if (!loadingDiv) {
                loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading-overlay';
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    color: white;
                    font-size: 18px;
                `;
                document.body.appendChild(loadingDiv);
            }
            
            loadingDiv.innerHTML = `
                <div style="text-align: center; background: white; padding: 30px; border-radius: 10px; color: #333;">
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                    <h3 style="margin: 10px 0;">${mensagem}</h3>
                </div>
            `;
            
            // Adicionar anima√ß√£o
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            loadingDiv.style.display = 'flex';
        }
        
        function esconderLoading() {
            const loadingDiv = document.getElementById('loading-overlay');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar bot√µes
            document.getElementById('btnEntrarTurma').addEventListener('click', () => {
                mostrarModal('modalEntrarTurma');
            });
            
            document.getElementById('btnLogout').addEventListener('click', logout);
            
            // Fechar modal ao clicar fora
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Carregar dados do aluno
            carregarDadosAluno();
        });
    </script>
</body>
</html>